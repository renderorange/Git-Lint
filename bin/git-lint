#!/usr/bin/env perl

use strict;
use warnings;

use FindBin;
use lib "$FindBin::RealBin/../lib";

use Getopt::Long ();
use Pod::Usage   ();
use Git::Lint;

my $VERSION = '0.002';

my %opt = (
    profile => 'default',
);
Getopt::Long::GetOptions(
    \%opt,
    'check=s',
    'profile=s',
    'version' => sub { print "git-lint version $VERSION\n"; exit 0 },
    'help',
) or Pod::Usage::pod2usage( -exitval => 1 );

Pod::Usage::pod2usage( -exitval => 0 ) if ( $opt{help} );
Pod::Usage::pod2usage( -exitval => 1 ) unless ( $opt{check} && ( $opt{check} eq 'commit' || $opt{check} eq 'message' ) );

if ( $opt{check} eq 'message' ) {
    $opt{file} = shift @ARGV;
    Pod::Usage::pod2usage( -exitval => 1 ) unless $opt{file};
}

delete $opt{version};
delete $opt{help};

my $lint = Git::Lint->new();
$lint->run(\%opt);

if ( $lint->{issues} ) {
    print STDERR "git-lint: the following issues were found in your ";

    if ($opt{check} eq 'commit') {
        print STDERR "commit\n\n";

        foreach my $filename ( keys %{ $lint->{issues} } ) {
            print STDERR $filename . "\n";
            print STDERR $_ . "\n" foreach @{ $lint->{issues}{$filename} };
            print STDERR "\n";
        }
    }
    else {
        print STDERR "commit message\n\n";
        print STDERR $_ . "\n" foreach @{ $lint->{issues} };
        print STDERR "\n";
    }

    exit 1;
}

exit 0;

__END__

=pod

=head1 NAME

git-lint - linter for git

=head1 SYNOPSIS

 git-lint [--check <commit|message>] <message_file> [--profile <name>] [--version] [--help]

=head1 DESCRIPTION

C<git-lint> is a program to lint git commits.

=head1 OPTIONS

=over

=item --check

Run either check mode commit or message.

If check type is message, C<git-lint> expects the file path of the commit message to check as an unnamed option.

=item --profile

Run a specific profile of check modules.

Defaults to the 'default' profile.

=item --version

Print the version.

=item --help

Print the help menu.

=back

=head1 AUTHOR

Blaine Motsinger C<blaine@renderorange.com>

=cut
